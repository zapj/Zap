import{r as y,J as U,o as ce,K as fe,a as E,f as M,j as t,w as l,F as A,m as g,e as V,p as d,L as _e,b as F,h as C,t as k,k as N,g as we,M as ge,x as be,y as ve}from"./index-e26e72e9.js";/* empty css                   */import{E as he}from"./el-drawer-6550ab44.js";import"./el-overlay-797d8413.js";import{E as ye,a as Ee}from"./el-form-item-3f424c56.js";/* empty css                 *//* empty css               */import{E as xe,a as Ve,b as Ce}from"./el-pagination-44938618.js";import"./el-scrollbar-eafc889c.js";import"./el-tooltip-95af38b0.js";/* empty css                */import{E as ke}from"./el-card-e1aad0b1.js";import{E as ze,a as De}from"./el-table-column-95096c36.js";import{E as Se}from"./el-empty-804f1e22.js";import{E as Ie}from"./el-button-91f41336.js";/* empty css                        */import{E as Fe,a as $e,b as We}from"./el-dropdown-item-8b1b1512.js";import{a as Le,E as Ue}from"./el-col-fa218f38.js";import{a as _,v as Te}from"./client-00b0bb33.js";import{p as Oe,d as je,f as qe}from"./index-0e6c4a62.js";import{I as H}from"./iconify-b78473e0.js";import{_ as Be}from"./_plugin-vue_export-helper-c27b6911.js";import{E as p}from"./index-b3b7ff7e.js";import{E as Me}from"./index-3bac334e.js";import{E as Ae}from"./index-679b04b8.js";import"./index-6fc089e4.js";import"./error-78e43d3e.js";import"./runtime-909e2ee3.js";import"./vnode-4474326f.js";import"./focus-trap-f40e746e.js";import"./typescript-d2ff6dd6.js";import"./isNil-c75b1b34.js";import"./index-6838fe58.js";import"./use-global-config-e0c846e4.js";import"./use-form-common-props-0f5bc46c.js";import"./constants-b6c0c234.js";import"./event-8e91c63d.js";import"./index-9f57bd93.js";import"./castArray-cf011fb0.js";import"./_initCloneObject-9228ffc4.js";import"./index-15ea5ace.js";import"./use-form-item-59e5f47e.js";import"./refs-5d6d1997.js";const Ne=z=>(be("data-v-353f65be"),z=z(),ve(),z),He=Ne(()=>g("span",{class:"font-500 mr-3 color-zinc-600"}," 网站管理 ",-1)),Pe={class:"flex justify-end"},Je={class:"el-dropdown-link"},Ke=["id"],Re={style:{float:"left"}},Ge={style:{float:"right",color:"var(--el-text-color-secondary)"}},Qe={style:{flex:"auto"}},w="140px",Xe={__name:"Sites",setup(z){let D=!1;const x=y([]),$=y(400),S=y(),m=y(!1),I=y("50%"),T=y("添加网站"),o=U({domain:"",title:"",description:"",domain_names:"",www_root:"",run_directory:"",application:0,website_id:0,index_files:"index.html index.htm index.php"}),u=U({config:{}}),s=U({total:0,pagesize:50,currentpage:1,tbLoading:!1}),P={domain:[{required:!0,trigger:"blur",validator:(i,e,n)=>{e==""&&e===void 0&&n(new Error("域名不能为空")),_({url:"v1/website/check_domain",dataType:"form",data:{domain:e,website_id:o.website_id},method:"POST",loading:!1}).then(r=>{r.code===0?n():n(new Error(r.msg))}).catch(r=>{n(new Error("域名验证失败"))})}},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],title:[{required:!0,message:"请输入网站名称",trigger:"blur"}],www_root:[{required:!0,message:"请输入站点目录",trigger:"blur"}],application:[{required:!0,message:"请选择应用类型",trigger:"change"}]};ce(()=>{b({page:1,pagesize:s.pagesize}),window.addEventListener("resize",W)}),fe(()=>{window.removeEventListener("resize",W)});const J=()=>{o.www_root===""&&(o.www_root=o.domain.replaceAll("*.","")),o.title===""&&(o.title=o.domain.replaceAll("www.",""))},K=()=>_({url:"/v1/website/config",method:"get"}).then(i=>{if(i.code===0)u.config=i.data;else{p.error(i.msg),m.value=!1;return}}),O=(i,e)=>{_({url:"/v1/website/set/status",method:"post",data:{id:x.value[i].ID,status:e},dataType:"form"}).then(n=>{n.code===0?(p.success(n.msg),b({page:1,pagesize:s.pagesize})):p.error(n.msg)})},j=i=>{D=!0,m.value=!0,T.value="网站设置",o.website_id=i,_({url:"/v1/website/settings",method:"get",params:{id:i}}).then(e=>{if(e.code===0)u.config=e.data.config,o.domain=e.data.website.domain,o.domain_names=e.data.website.domain_names,o.www_root=e.data.website.www_root,o.run_directory=e.data.website.run_directory,o.application=e.data.website.application_id,o.title=e.data.website.title,o.description=e.data.website.description,o.index_files=e.data.website.index_files,o.website_id=e.data.website.ID,o.www_root===""?o.www_root=o.domain.replaceAll("*.",""):o.www_root=e.data.website.www_root.replace(u.config.home_dir+"/",""),o.title===""&&(o.title=o.domain.replaceAll("www.",""));else{p.error(e.msg),m.value=!1;return}})},R=i=>{i&&(i.resetFields(),m.value=!1)},G=i=>{K().finally(()=>{m.value=!0}),D=!1,o.website_id=0,i&&i.resetFields()},Q=i=>{if(!i)return;i.validate(r=>{if(!r)return!1});let e=Object.assign({},o);if(u.config.applications.length===0){p.error("请先添加应用");return}let n=null;if(u.config.applications.forEach((r,q)=>{r.id===o.application&&(n=r)}),!n){p.error("应用不存在");return}e.expose_port=n.expose_port,e.expose_proto=n.expose_proto,e.application=n.id,_({url:D?"/v1/website/update":"/v1/website/create",method:"post",data:e}).then(r=>{r.code===0?(p.success(D?"更新成功":"添加成功"),b({page:1,pagesize:s.pagesize})):p.error(r.msg)}).finally(()=>{m.value=!1,i.resetFields()})},X=i=>{j(i)},Y=()=>{b({page:s.currentpage,pagesize:s.pagesize})},Z=(i,e)=>{s.currentpage=i,s.pagesize=e,b({page:i,pagesize:e})},W=()=>{document.body.clientWidth<1200&&document.body.clientWidth>768?I.value="60%":document.body.clientWidth<768?I.value="100%":I.value="50%";let i=document.body.clientHeight-215-140;i<300?$.value=300:$.value=i};function b(i){i=Object.assign({page:1,pagesize:50},i),s.tbLoading=!0,_({url:"/v1/website/list",method:"get",params:{path:i.path,page:i.page,limit:i.pagesize},dataType:"form",loading:!1}).then(n=>{x.value=[],x.value.push(...n.data),s.total=n.total,s.currentpage=n.page,W()}).catch(n=>{console.log(n)}).finally(()=>s.tbLoading=!1)}const ee=i=>{_({url:"/v1/website/delete",method:"post",data:{id:x.value[i].ID},dataType:"form"}).then(e=>{e.code===0&&(p.success("网站删除成功"),b({page:1,pagesize:s.pagesize}))}).catch(e=>{p.error("网站删除失败")})};return(i,e)=>{const n=Ue,r=Ie,q=Le,v=ze,L=Fe,te=$e,oe=We,ae=Se,le=De,ie=xe,ne=ke,re=Me,h=Ae,c=ye,se=Ce,de=Ve,pe=Ee,me=he,ue=Te;return E(),M(A,null,[t(q,{class:"row-bg",justify:"space-between mb-5"},{default:l(()=>[t(n,{span:6},{default:l(()=>[He]),_:1}),t(n,{span:6}),t(n,{span:6},{default:l(()=>[g("div",Pe,[t(r,{type:"success",icon:V(Oe),class:"ml-2",onClick:e[0]||(e[0]=a=>G(S.value))},{default:l(()=>[d("创建网站")]),_:1},8,["icon"])])]),_:1})]),_:1}),t(ne,{class:"box-card filemanager","body-style":"padding:0"},{footer:l(()=>[t(ie,{background:"",layout:"total,prev, pager, next",total:s.total,"page-size":s.pagesize,"current-page":s.currentpage,"onUpdate:currentPage":e[1]||(e[1]=a=>s.currentpage=a),"default-current-page":1,onChange:Z},null,8,["total","page-size","current-page"])]),default:l(()=>[_e((E(),F(le,{data:x.value,"min-height":"300",style:{width:"100%"},height:$.value,fit:""},{empty:l(()=>[t(ae,{description:"暂无数据"},{default:l(()=>[t(r,{type:"primary",onClick:Y},{default:l(()=>[d("刷新")]),_:1})]),_:1})]),default:l(()=>[t(v,{type:"selection",width:"30"}),t(v,{prop:"domain",label:"域名","show-overflow-tooltip":""},{default:l(({row:a,$index:f})=>[t(r,{link:"",onClick:C(B=>X(a.ID),["prevent"])},{icon:l(()=>[t(V(H),{icon:"dashicons:admin-site"})]),default:l(()=>[d(" "+k(a.domain),1)]),_:2},1032,["onClick"])]),_:1}),t(v,{prop:"title",label:"网站名称"}),t(v,{prop:"www_root",label:"站点目录"}),t(v,{prop:"status",label:"网站状态",width:"120"}),t(v,{label:"操作",width:"100"},{default:l(a=>[t(r,{icon:V(je),circle:"",class:"mr-2 hidden-md-and-down",title:"设置网站",onClick:C(f=>j(a.row.ID),["prevent"])},null,8,["icon","onClick"]),t(oe,null,{dropdown:l(()=>[t(te,null,{default:l(()=>[t(L,{onClick:C(f=>ee(a.$index),["prevent"])},{default:l(()=>[d("删除")]),_:2},1032,["onClick"]),a.row.status==="running"?(E(),F(L,{key:0,onClick:C(f=>O(a.$index,"suspend"),["prevent"])},{default:l(()=>[d("暂停")]),_:2},1032,["onClick"])):N("",!0),a.row.status==="suspend"?(E(),F(L,{key:1,onClick:C(f=>O(a.$index,"running"),["prevent"])},{default:l(()=>[d("启动")]),_:2},1032,["onClick"])):N("",!0)]),_:2},1024)]),default:l(()=>[g("span",Je,[t(V(H),{icon:"ri:more-fill",width:"24",height:"24"})])]),_:2},1024)]),_:1})]),_:1},8,["data","height"])),[[ue,s.tbLoading]])]),_:1}),t(me,{modelValue:m.value,"onUpdate:modelValue":e[11]||(e[11]=a=>m.value=a),direction:"rtl",size:I.value,"show-close":!1},{header:l(({close:a,titleId:f,titleClass:B})=>[g("h4",{id:f,class:we(B)},k(T.value),11,Ke),t(r,{onClick:a},{default:l(()=>[t(re,{class:"el-icon--left"},{default:l(()=>[t(V(qe))]),_:1}),d(" 关闭 ")]),_:2},1032,["onClick"])]),default:l(()=>[t(pe,{model:o,"label-position":"left",ref_key:"websiteFormDrawerRef",ref:S,rules:P},{default:l(()=>[t(c,{label:"域名","label-width":w,prop:"domain"},{default:l(()=>[t(h,{modelValue:o.domain,"onUpdate:modelValue":e[2]||(e[2]=a=>o.domain=a),autocomplete:"off",onChange:J},null,8,["modelValue"])]),_:1}),t(c,{label:"附加域名","label-width":w,prop:"domain_names"},{default:l(()=>[t(h,{modelValue:o.domain_names,"onUpdate:modelValue":e[3]||(e[3]=a=>o.domain_names=a),autocomplete:"off",type:"textarea"},null,8,["modelValue"])]),_:1}),t(c,{label:"网站名称","label-width":w,prop:"title"},{default:l(()=>[t(h,{modelValue:o.title,"onUpdate:modelValue":e[4]||(e[4]=a=>o.title=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),t(c,{label:"站点目录","label-width":w,prop:"www_root"},{default:l(()=>[t(h,{modelValue:o.www_root,"onUpdate:modelValue":e[5]||(e[5]=a=>o.www_root=a),autocomplete:"off"},{prepend:l(()=>[d(k(u.config.home_dir)+"/",1)]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"默认主页","label-width":w,prop:"index_files"},{default:l(()=>[t(h,{modelValue:o.index_files,"onUpdate:modelValue":e[6]||(e[6]=a=>o.index_files=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),t(c,{label:"应用类型","label-width":w,prop:"application"},{default:l(()=>[t(de,{modelValue:o.application,"onUpdate:modelValue":e[7]||(e[7]=a=>o.application=a),class:"m-2",placeholder:"中间件服务器",style:{width:"240px"}},{default:l(()=>[(E(!0),M(A,null,ge(u.config.applications,(a,f)=>(E(),F(se,{key:a.id,label:a.title,value:a.id},{default:l(()=>[g("span",Re,k(a.title),1),g("span",Ge,k(a.expose_port),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"备注","label-width":w,prop:"description"},{default:l(()=>[t(h,{modelValue:o.description,"onUpdate:modelValue":e[8]||(e[8]=a=>o.description=a),autocomplete:"off",type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),footer:l(()=>[g("div",Qe,[t(r,{onClick:e[9]||(e[9]=a=>R(S.value))},{default:l(()=>[d("取消")]),_:1}),t(r,{type:"primary",onClick:e[10]||(e[10]=a=>Q(S.value))},{default:l(()=>[d("确认")]),_:1})])]),_:1},8,["modelValue","size"])],64)}}},Mt=Be(Xe,[["__scopeId","data-v-353f65be"]]);export{Mt as default};
